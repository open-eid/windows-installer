<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Bundle Name="eID software" Version="$(var.MSI_VERSION)" Manufacturer="RIA"
      UpgradeCode="f1c4d351-269d-4bee-8cdb-6ea70c968875"
      Copyright="RIA" IconSourceFile="$(var.path)\ID.ico" AboutUrl="http://www.id.ee">
    <BootstrapperApplicationRef
        Id="WixStandardBootstrapperApplication.HyperlinkSidebarLicense"
        bal:UseUILanguages="yes">
      <bal:WixStandardBootstrapperApplication
          LicenseUrl=""
          LogoFile="$(var.path)\banner.bmp"
          LogoSideFile="$(var.path)\dlgbmp.bmp"
          ThemeFile="$(var.path)\HyperlinkSidebarTheme.xml"/>
        <Payload Name="1033\thm.wxl" SourceFile="$(var.path)\HyperlinkSidebarTheme.en.wxl"/>
        <Payload Name="1061\thm.wxl" SourceFile="$(var.path)\HyperlinkSidebarTheme.et.wxl"/>
    </BootstrapperApplicationRef>

    <bal:Condition Message="#(loc.SupportedWindows)">VersionNT >= v10.0 AND VersionNT64</bal:Condition>

    <Variable Name="NoBrowserRestart" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="0"/>
    <Variable Name="ChromeSupport" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="EdgeSupport" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="ForceChromeExtensionActivation2" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="ForceEdgeExtensionActivation2" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="FirefoxSupport" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="InstallCertSynchronizer" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="0"/>
    <Variable Name="MinidriverInstall" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="Qdigidoc4Install" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="IconsDesktop" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="AutoUpdate" Persisted="yes" bal:Overridable="yes" Type="numeric" Value="1"/>
    <Variable Name="InstallFolder" Type="string" Value="[ProgramFiles6432Folder]Open-EID"/>

    <?define REGPath = "Software\[WixBundleManufacturer]\Open-EID"?>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="ChromeSupport" Variable="ChromeSupportExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="ChromeSupport" Variable="ChromeSupport" Condition="ChromeSupportExists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="EdgeSupport" Variable="EdgeSupportExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="EdgeSupport" Variable="EdgeSupport" Condition="EdgeSupportExists"/>
    <!--util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="ForceChromeExtensionActivation2" Variable="ForceChromeExtensionActivation2Exists" Result="exists"/-->
    <!--util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="ForceChromeExtensionActivation2" Variable="ForceChromeExtensionActivation2" Condition="ForceChromeExtensionActivation2Exists"/-->
    <!--util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="ForceEdgeExtensionActivation2" Variable="ForceEdgeExtensionActivation2Exists" Result="exists"/-->
    <!--util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="ForceEdgeExtensionActivation2" Variable="ForceEdgeExtensionActivation2" Condition="ForceEdgeExtensionActivation2Exists"/-->
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="FirefoxSupport" Variable="FirefoxSupportExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="FirefoxSupport" Variable="FirefoxSupport" Condition="FirefoxSupportExists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="MinidriverInstall" Variable="MinidriverInstallExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="MinidriverInstall" Variable="MinidriverInstall" Condition="MinidriverInstallExists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="Qdigidoc4Install" Variable="Qdigidoc4InstallExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="Qdigidoc4Install" Variable="Qdigidoc4Install" Condition="Qdigidoc4InstallExists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="AutoUpdate" Variable="AutoUpdateExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="AutoUpdate" Variable="AutoUpdate" Condition="AutoUpdateExists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="IconsDesktop" Variable="IconsDesktopExists" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="$(var.REGPath)" Value="IconsDesktop" Variable="IconsDesktop" Condition="IconsDesktopExists"/>
    <util:RegistrySearch Root="HKLM" Key="SOFTWARE\Policies\Microsoft\Edge" Value="StartupBoostEnabled" Variable="StartupBoostEnabledSet" Result="exists"/>
    <util:RegistrySearch Root="HKLM" Key="SOFTWARE\Policies\Microsoft\Edge" Value="StartupBoostEnabled" Variable="StartupBoostEnabledValue" Condition="StartupBoostEnabledSet"/>
    <util:ProductSearch Id="OpenEID_Installed" UpgradeCode="42137cbc-8356-4ac4-9295-735f258b5abb" Variable="Installed" />
    <util:ProductSearch Id="WebEID_Installed" UpgradeCode="4f0e0fef-0dbc-481b-9d81-08921740f781" Variable="WebEIDInstalled" />

    <Chain>
      <MsiPackage Id="BrowserRestart.EN" ForcePerMachine="yes" SourceFile="browserrestart.en-US.msi" Compressed="yes"
          InstallCondition="NOT UserLanguageID = 1061 AND Installed &gt; v0.0.0.0 AND WebEIDInstalled = v0.0.0.0 AND NoBrowserRestart = 0 AND ((ChromeSupport AND ForceChromeExtensionActivation2) OR FirefoxSupport)">
        <MsiProperty Name="TARGETDIR" Value="[InstallFolder]"/>
        <MsiProperty Name="RESTARTCHROME" Value="[ForceChromeExtensionActivation2]"/>
        <MsiProperty Name="RESTARTEDGE" Value="[ForceEdgeExtensionActivation2]"/>
        <MsiProperty Name="RESTARTFIREFOX" Value="[FirefoxSupport]"/>
      </MsiPackage>
      <MsiPackage Id="BrowserRestart.ET" ForcePerMachine="yes" SourceFile="browserrestart.et-EE.msi" Compressed="yes"
          InstallCondition="UserLanguageID = 1061 AND Installed &gt; v0.0.0.0 AND WebEIDInstalled = v0.0.0.0 AND NoBrowserRestart = 0 AND ((ChromeSupport AND ForceChromeExtensionActivation2) OR FirefoxSupport)">
        <MsiProperty Name="TARGETDIR" Value="[InstallFolder]"/>
        <MsiProperty Name="RESTARTCHROME" Value="[ForceChromeExtensionActivation2]"/>
        <MsiProperty Name="RESTARTEDGE" Value="[ForceEdgeExtensionActivation2]"/>
        <MsiProperty Name="RESTARTFIREFOX" Value="[FirefoxSupport]"/>
      </MsiPackage>

      <MsiPackage Id="IDEMIA.en_US.X64" InstallCondition="NOT UserLanguageID = 1061 AND MinidriverInstall = 1" ForcePerMachine="yes"
          SourceFile="$(var.idemia).x64.en-US.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="INSTALLCERTSYNCHRONIZER" Value="[InstallCertSynchronizer]"/>
        <MsiProperty Name="INSTALL_DRIVER" Value="1"/>
      </MsiPackage>
      <MsiPackage Id="IDEMIA.et_EE.X64" InstallCondition="UserLanguageID = 1061 AND MinidriverInstall = 1" ForcePerMachine="yes"
          SourceFile="$(var.idemia).x64.et-EE.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="INSTALLCERTSYNCHRONIZER" Value="[InstallCertSynchronizer]"/>
        <MsiProperty Name="INSTALL_DRIVER" Value="1"/>
      </MsiPackage>

      <MsiPackage Id="Updater.X64" ForcePerMachine="yes"
          SourceFile="$(var.updater).x64.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="AUTO_UPDATE" Value="[AutoUpdate]"/>
        <MsiProperty Name="REINSTALLMODE" Value="amus"/>
      </MsiPackage>

      <MsiPackage Id="WebEID.X64" InstallCondition="(ChromeSupport = 1 OR EdgeSupport = 1 OR FirefoxSupport = 1)" ForcePerMachine="yes"
          SourceFile="$(var.webeid).x64.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="REINSTALLMODE" Value="amus"/>
        <MsiProperty Name="CHROMEINSTALL" Value="[ChromeSupport]"/>
        <MsiProperty Name="CHROMEPOLICY" Value="[ForceChromeExtensionActivation2]"/>
        <MsiProperty Name="EDGEINSTALL" Value="[EdgeSupport]"/>
        <MsiProperty Name="EDGEPOLICY" Value="[ForceEdgeExtensionActivation2]"/>
        <MsiProperty Name="FIREFOXINSTALL" Value="[FirefoxSupport]"/>
      </MsiPackage>

      <MsiPackage Id="qdigidoc4.en_US.X64" InstallCondition="NOT UserLanguageID = 1061 AND Qdigidoc4Install = 1" ForcePerMachine="yes"
          SourceFile="$(var.qdigidoc4).x64.en-US.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="DESKTOP_SHORTCUT" Value="[IconsDesktop]"/>
        <MsiProperty Name="REINSTALLMODE" Value="amus"/>
      </MsiPackage>
      <MsiPackage Id="qdigidoc4.et_EE.X64" InstallCondition="UserLanguageID = 1061 AND Qdigidoc4Install = 1" ForcePerMachine="yes"
          SourceFile="$(var.qdigidoc4).x64.et-EE.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="DESKTOP_SHORTCUT" Value="[IconsDesktop]"/>
        <MsiProperty Name="REINSTALLMODE" Value="amus"/>
      </MsiPackage>

      <MsiPackage Id="shellext.X64" InstallCondition="Qdigidoc4Install = 1" ForcePerMachine="yes"
          SourceFile="$(var.shellext).x64.msi" DownloadUrl="$(var.URL)" Compressed="$(var.embed)">
        <MsiProperty Name="APPLICATIONFOLDER" Value="[InstallFolder]"/>
        <MsiProperty Name="REINSTALLMODE" Value="amus"/>
      </MsiPackage>

      <MsiPackage Id="MetaInfo" ForcePerMachine="yes" SourceFile="metainfo.msi" Compressed="yes">
        <MsiProperty Name="ChromeSupport" Value="[ChromeSupport]"/>
        <MsiProperty Name="EdgeSupport" Value="[EdgeSupport]"/>
        <MsiProperty Name="ForceChromeExtensionActivation2" Value="[ForceChromeExtensionActivation2]"/>
        <MsiProperty Name="ForceEdgeExtensionActivation2" Value="[ForceEdgeExtensionActivation2]"/>
        <MsiProperty Name="FirefoxSupport" Value="[FirefoxSupport]"/>
        <MsiProperty Name="MinidriverInstall" Value="[MinidriverInstall]"/>
        <MsiProperty Name="Qdigidoc4Install" Value="[Qdigidoc4Install]"/>
        <MsiProperty Name="AutoUpdate" Value="[AutoUpdate]"/>
        <MsiProperty Name="IconsDesktop" Value="[IconsDesktop]"/>
        <MsiProperty Name="StartupBoostEnabledSet" Value="[StartupBoostEnabledSet]"/>
        <MsiProperty Name="StartupBoostEnabledValue" Value="[StartupBoostEnabledValue]"/>
      </MsiPackage>
    </Chain>
  </Bundle>
</Wix>
